# Architecture Decision Records (ADRs)

## ADR-004: Idempotencia mediante Idempotency Keys

### Contexto

En sistemas distribuidos, requests pueden duplicarse por reintentos de red, timeouts, o errores de cliente. Necesitamos garantizar que comandos críticos se ejecuten exactamente una vez.

### Decisión

Implementar **idempotencia** usando:

1. **Header Opcional:**

    ```http
    X-Idempotency-Key: unique-key-12345
    ```

2. **Tabla de Tracking:**

    ```sql
    CREATE TABLE idempotency_keys (
        tenant_id VARCHAR(100),
        key VARCHAR(255),
        processed_at TIMESTAMP,
        CONSTRAINT unique_key UNIQUE (tenant_id, key)
    );
    ```

3. **Validación en el los casos de uso:**

```go
func (h *Handler) Execute(cmd CreateUserCommand) error {
    if cmd.IdempotencyKey != "" {
        processed := h.idempotency.IsProcessed(cmd.TenantID, cmd.IdempotencyKey)
        if processed {
            return ErrAlreadyProcessed // 409 Conflict
        }
    }
    
    // Procesar comando...
    
    if cmd.IdempotencyKey != "" {
        h.idempotency.MarkAsProcessed(cmd.TenantID, cmd.IdempotencyKey)
    }
}
```

### Consecuencias

**Positivas:**

- Previene duplicación de comandos
- Safe retries desde cliente
- Cumple con estándares de API (Stripe, PayPal)

**Negativas:**

- Almacenamiento adicional
- Cliente debe generar keys únicas
